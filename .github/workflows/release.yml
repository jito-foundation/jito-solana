name: Release

on:
  push:
    tags:
      - "*"

jobs:
  draft-release:
    if: github.repository == 'jito-labs/bam-client'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          # Fetch full history so tags and submodule commits are available
          fetch-depth: 0
          # Initialize and update submodules recursively
          submodules: recursive

      - name: Create release
        id: create
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ github.ref_name }}',
              name: 'Release ${{ github.ref_name }}',
              body: 'ðŸš§',
              draft: false,
              prerelease: true
            });
            core.setOutput('upload_url', release.data.upload_url);

      - name: Create tarball with submodules
        run: |
          RELEASE_NAME="bam-client-${{ github.ref_name }}.tar.gz"
          tar --exclude-vcs -C . -czf "/tmp/$RELEASE_NAME" .
          mv "/tmp/$RELEASE_NAME" .

      - name: Upload source-with-submodules tarball
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create.outputs.upload_url }}
          asset_path: ./bam-client-${{ github.ref_name }}.tar.gz
          asset_name: bam-client-${{ github.ref_name }}.tar.gz
          asset_content_type: application/gzip

  # version-bump:
  #   if: github.repository == 'anza-xyz/agave'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v5
  #       with:
  #         fetch-depth: 0
  #         token: ${{ secrets.VERSION_BUMP_PAT }}

  #     - name: Parse Info
  #       id: parse_info
  #       run: |
  #         # get the next version
  #         version=${{ github.ref_name }}
  #         major=$(echo $version | cut -d'.' -f1)
  #         minor=$(echo $version | cut -d'.' -f2)
  #         patch=$(echo $version | cut -d'.' -f3)
  #         next_version=$major.$minor.$((patch+1))
  #         : "${next_version:?}"

  #         # get the traget branch
  #         target_branch=$major.$minor
  #         : "${target_branch:?}"

  #         echo "next_version=$next_version" | tee -a $GITHUB_OUTPUT
  #         echo "target_branch=$target_branch" | tee -a $GITHUB_OUTPUT

  #     - name: Create branch and make changes
  #       run: |
  #         next_version=${{ steps.parse_info.outputs.next_version }}

  #         git checkout -b version-bump-$next_version
  #         ./scripts/increment-cargo-version.sh patch

  #         git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
  #         git config user.name "github-actions[bot]"
  #         git commit -am "Bump version to $next_version"
  #         git push origin version-bump-$next_version

  #     - name: Create PR
  #       uses: actions/github-script@v7
  #       with:
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
  #         script: |
  #           github.rest.pulls.create({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             title: 'Bump version to ${{ steps.parse_info.outputs.next_version }}',
  #             head: 'version-bump-${{ steps.parse_info.outputs.next_version }}',
  #             base: '${{ steps.parse_info.outputs.target_branch }}'
  #           })
